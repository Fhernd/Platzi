<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Precios de Libros</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div id="app" class="container mt-5">
        <h1 class="mb-4">Comparador de Precios de Libros</h1>
        <form @submit.prevent="addComparison">
            <div class="mb-3">
                <label for="title" class="form-label">Título del Libro</label>
                <input type="text" id="title" v-model="newComparison.title" class="form-control" required>
            </div>
            <comparison-option v-for="(option, index) in newComparison.options" :key="index" :option="option" :index="index" @remove-option="removeOption"></comparison-option>
            <button type="button" class="btn btn-primary mb-3" @click="addOption">Agregar Opción</button>
            <button type="submit" class="btn btn-success mb-3">Agregar Comparación</button>
        </form>
        <h2 class="mt-4">Comparaciones Guardadas</h2>
        <div v-if="comparisons.length">
            <comparison v-for="(comparison, index) in comparisons" :key="index" :comparison="comparison"></comparison>
            <button class="btn btn-info" @click="exportCSV">Exportar a CSV</button>
        </div>
        <p v-else>No hay comparaciones guardadas.</p>
    </div>
    <script>
        const ComparisonOption = {
            props: ['option', 'index'],
            template: `
                <div class="border rounded p-3 mb-3">
                    <h5>Opción {{ index + 1 }}</h5>
                    <div class="mb-3">
                        <label class="form-label">Nombre de la Tienda</label>
                        <input type="text" v-model="option.store" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URL</label>
                        <input type="url" v-model="option.url" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precio</label>
                        <input type="number" v-model="option.price" class="form-control" required>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" v-model="option.discount">
                        <label class="form-check-label">
                            ¿Tiene descuento?
                        </label>
                    </div>
                    <button type="button" class="btn btn-danger mt-2" @click="$emit('remove-option', index)">Eliminar Opción</button>
                </div>
            `
        };

        const Comparison = {
            props: ['comparison'],
            template: `
                <div class="border rounded p-3 mb-3">
                    <h5>{{ comparison.title }}</h5>
                    <comparison-option v-for="(option, optIndex) in comparison.options" :key="optIndex" :option="option" :index="optIndex"></comparison-option>
                </div>
            `,
            components: {
                'comparison-option': ComparisonOption
            }
        };

        const app = Vue.createApp({
            data() {
                return {
                    newComparison: {
                        title: '',
                        options: [
                            { store: '', url: '', price: '', discount: false }
                        ]
                    },
                    comparisons: []
                };
            },
            created() {
                this.loadComparisons();
            },
            methods: {
                addOption() {
                    this.newComparison.options.push({ store: '', url: '', price: '', discount: false });
                },
                removeOption(index) {
                    this.newComparison.options.splice(index, 1);
                },
                addComparison() {
                    this.comparisons.push({ ...this.newComparison });
                    this.saveComparisons();
                    this.resetForm();
                },
                resetForm() {
                    this.newComparison = { title: '', options: [{ store: '', url: '', price: '', discount: false }] };
                },
                saveComparisons() {
                    localStorage.setItem('comparisons', JSON.stringify(this.comparisons));
                },
                loadComparisons() {
                    const storedComparisons = localStorage.getItem('comparisons');
                    if (storedComparisons) {
                        this.comparisons = JSON.parse(storedComparisons);
                    }
                },
                exportCSV() {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Título,Tienda,URL,Precio,Descuento\n";
                    this.comparisons.forEach(comparison => {
                        comparison.options.forEach(option => {
                            const discountText = option.discount ? 'Sí' : 'No';
                            csvContent += `${comparison.title},${option.store},${option.url},${option.price},${discountText}\n`;
                        });
                    });
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "comparaciones.csv");
                    document.body.appendChild(link);
                    link.click();
                }
            },
            components: {
                'comparison': Comparison,
                'comparison-option': ComparisonOption
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
